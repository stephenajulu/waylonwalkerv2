{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/creating-the-kedro-preflight-hook/","result":{"data":{"markdownRemark":{"id":"4b6b064d-73af-5dfd-997b-41af2f97a814","html":"<p>kedro hooks are an exciting upcoming feature of kedro <code class=\"language-text\">0.16.0</code>.  They allow you to hook into <code class=\"language-text\">catalog_created</code>,<code class=\"language-text\">pipeline_run</code>, and <code class=\"language-text\">node_run</code>(nouns). With a <code class=\"language-text\">before</code>, or <code class=\"language-text\">after</code> (adjective).  This really reminds me of reacts lifecycle hooks, that let you hook into various state of react web components.  This is going to make kedro so extendable by the community.  I am super pumped to see what the community is able to do with this ability.</p>\n<blockquote>\n<h3>What is Kedro ü§î</h3>\n<p>If you are completely unsure what kedro is be sure to check out my <a href=\"https://waylonwalker.com/wike\">what is kedro</a> post</p>\n</blockquote>\n<h2>Docs</h2>\n<p><em>a work in progress</em></p>\n<p>As this is a part of an upcoming release you will need to look in the <code class=\"language-text\">latest</code> docs, <strong>not</strong> <code class=\"language-text\">stable</code> and you will find a <a href=\"https://kedro.readthedocs.io/en/latest/04_user_guide/15_hooks.html?highlight=hooks\">15_hoooks</a> page.  As these docs are still in development they are not very complete at this point and do require a bit more existing <code class=\"language-text\">kedro</code> knowledge to understand.  I am sure they will get much better as we approach the realease of hooks.</p>\n<blockquote>\n<p>This doesn't mean that we can't still install the latest/unstable version and have some fun learning!</p>\n</blockquote>\n<h2>Installation</h2>\n<p><em>Straight from GitHub</em></p>\n<p>As this is part of an upcoming release you will need to get the library straight from github.  Since this is not a stable release of <code class=\"language-text\">kedro</code> I cannot express the importance of using a virtual environment enough.  Trying to install this version in the same place that you are trying to develop a pipeline potentially break your existing working development environment.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">conda create -n kedro0160 -y\nconda activate kedro0160 <span class=\"token comment\"># may also be source activate kedro0160 or activate kedro0160</span>\npip <span class=\"token function\">install</span> git+https://github.com/quantumblacklabs/kedro.git\npip <span class=\"token function\">install</span> colorama</code></pre></div>\n<blockquote>\n<p><strong>note</strong> the version is still somewhere between <code class=\"language-text\">0.15.9</code> and <code class=\"language-text\">0,16.0</code>.  <code class=\"language-text\">kedro.__version__</code> will still be <code class=\"language-text\">0.15.9</code> and wiill not roll until the official release.</p>\n</blockquote>\n<h2>Create a sample project</h2>\n<blockquote>\n<h3>Kedro new</h3>\n<p>For more details check out my full post on <a href=\"https://waylonwalker.com/knew\">kedro new</a></p>\n</blockquote>\n<p>For this post I really just want a working pipeline as fast as possible.  For this I am going to use iris pipeline that is generated from the <code class=\"language-text\">kedro new</code> command in the cli.  It's <strong>important</strong> that you answer <code class=\"language-text\">y</code> to create an example pipeline.</p>\n<blockquote>\n<h3>Hold On ‚úã</h3>\n<p>Did you create a separate environment for this?  Please do.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kedro new</code></pre></div>\n<p>After you run the <code class=\"language-text\">kedro new</code> command it will ask a series of questions.  üëá Here is how I answered them.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Project Name:\n<span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span>\nPlease enter a human readable name <span class=\"token keyword\">for</span> your new project.\nSpaces and punctuation are allowed.\n <span class=\"token punctuation\">[</span>New Kedro Project<span class=\"token punctuation\">]</span>: Kedro Hooks\nRepository Name:\n<span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span>\nPlease enter a directory name <span class=\"token keyword\">for</span> your new project repository.\nAlphanumeric characters, hyphens and underscores are allowed.\nLowercase is recommended.\n <span class=\"token punctuation\">[</span>kedro-hooks<span class=\"token punctuation\">]</span>:\nPython Package Name:\n<span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span>\nPlease enter a valid Python package name <span class=\"token keyword\">for</span> your project package.\nAlphanumeric characters and underscores are allowed.\nLowercase is recommended. Package name must start with a letter or underscore.\n <span class=\"token punctuation\">[</span>kedro_hooks<span class=\"token punctuation\">]</span>:\nGenerate Example Pipeline:\n<span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span>\nDo you want to generate an example pipeline <span class=\"token keyword\">in</span> your project?\nGood <span class=\"token keyword\">for</span> first-time users. <span class=\"token punctuation\">(</span>default<span class=\"token operator\">=</span>N<span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">[</span>y/N<span class=\"token punctuation\">]</span>: y\nChange directory to the project generated <span class=\"token keyword\">in</span> /mnt/c/temp/kedro-hooks/\nA best-practice setup includes initialising <span class=\"token function\">git</span> and creating a virtual environment before running <span class=\"token variable\"><span class=\"token variable\">`</span>kedro <span class=\"token function\">install</span><span class=\"token variable\">`</span></span> to <span class=\"token function\">install</span> project-specific dependencies. Refer to the Kedro documentation: https://kedro.readthedocs.io/</code></pre></div>\n<h3>Install the Project</h3>\n<p>Next install the project itself and all of its dependencies with the <code class=\"language-text\">kedro install</code> command.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> kedro-hooks\nkedro <span class=\"token function\">install</span></code></pre></div>\n<h3>üèÉ‚Äç‚ôÄÔ∏è Run the pipeline</h3>\n<p>Before we start developing any hooks lets make sure everything is setup correctly by running the pipeline with <code class=\"language-text\">kedro run</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kedro run</code></pre></div>\n<h2>Let's make a hook</h2>\n<p><em>getting to the meat of the post</em></p>\n<p>Now that we have a project scaffolded up and running we can develop a hook for it.  As far as I can tell hooks can be implemented one of <strong>two ways</strong>.  As a <strong>function</strong> inside of a module, then import that module and pass it into the hooks list, or implemented as a method on a <strong>class</strong>, then the class is passed into the hooks list.  Either method must follow the naming convention with the <code class=\"language-text\">@hook_impl</code> decorator.  Each module/class can implement more than one hook, but not more than one of the same type. One of each kind will be created below.</p>\n<h3>Full list of hooks available</h3>\n<blockquote>\n<p><code class=\"language-text\">before_catalog_created</code></p>\n<p><code class=\"language-text\">after_catalog_created</code></p>\n<p><code class=\"language-text\">before_pipeline_run</code></p>\n<p><code class=\"language-text\">after_pipeline_run</code></p>\n<p><code class=\"language-text\">before_node_run</code></p>\n<p><code class=\"language-text\">after_node_run</code></p>\n</blockquote>\n<h2>debug_hook (class)</h2>\n<p><em>quick and dirty</em></p>\n<p>I highly recommend this as your first hook.  It's super easy to make and lets you explore the arguments passed into the hook.  For this one I am going to pop the following class right into <code class=\"language-text\">kedro-hooks/src/kedro-hooks/run.py</code>, remember that I chose <code class=\"language-text\">kedro-hooks</code> as my project name.  Your path might be slightly different.  If you wanted to make a real hook it might make sense to put it in its own module, but for simplicity of your first hook you can put it directly in the same module that it gets implemented.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">debug_hook</span><span class=\"token punctuation\">:</span>\n    <span class=\"token decorator annotation punctuation\">@hook_impl</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">before_pipeline_run</span><span class=\"token punctuation\">(</span>run_params<span class=\"token punctuation\">,</span> pipeline<span class=\"token punctuation\">,</span> catalog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">\"pops into a debugger before pipeline run\"</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'I hooked in right before the pipeline run'</span><span class=\"token punctuation\">)</span>\n        breakpoint<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>It is really that easy to create a kedro hook!  Now lets apply it to our project.  All we need to do is add one line (<code class=\"language-text\">hooks = [debug_hook]</code>) to the existing <code class=\"language-text\">ProjectContext</code> class within <code class=\"language-text\">kedro-hooks/src/kedro-hooks/run.py</code>.  Once we do that our <code class=\"language-text\">ProjectContext</code> will look like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ProjectContext</span><span class=\"token punctuation\">(</span>KedroContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Users can override the remaining methods from the parent class here,\n    or create new ones (e.g. as required by plugins)\n    \"\"\"</span>\n\n    project_name <span class=\"token operator\">=</span> <span class=\"token string\">\"kedro-hooks\"</span>\n    <span class=\"token comment\"># `project_version` is the version of kedro used to generate the project</span>\n    project_version <span class=\"token operator\">=</span> <span class=\"token string\">\"0.15.9\"</span>\n    package_name <span class=\"token operator\">=</span> <span class=\"token string\">\"kedro-hooks\"</span>\n\n    hooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> debug_hook <span class=\"token punctuation\">]</span> <span class=\"token comment\"># üëà This is where you implement the hook</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">_get_pipelines</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Dict<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> Pipeline<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> create_pipelines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Run it!  While you are in the debugger, explore what the <code class=\"language-text\">run_params</code>, <code class=\"language-text\">pipeine</code>, and <code class=\"language-text\">catalog</code> arguments give you.  This will give you some insight to what to expect when creating your next hook.</p>\n<h2>preflight hook (module)</h2>\n<p><em>giving it a bit more flair</em></p>\n<p>Create a new file <code class=\"language-text\">kedro-hooks/src/kedro-hooks/preflight.py</code> and place the following content into the file.  This will raise a <code class=\"language-text\">DataSetNotFoundError</code> before wasting time running any of the pipeline.  This could be useful to save some developer time for long running pipelines by warning them that they don't have all of the raw data they need before running.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># kedro-hooks/src/kedro-hooks/preflight.py</span>\n<span class=\"token keyword\">from</span> kedro<span class=\"token punctuation\">.</span>hooks <span class=\"token keyword\">import</span> hook_impl\n<span class=\"token keyword\">from</span> kedro<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>core <span class=\"token keyword\">import</span> DataSetNotFoundError\n<span class=\"token keyword\">from</span> colorama <span class=\"token keyword\">import</span> Fore\n<span class=\"token keyword\">import</span> textwrap\n\n\n<span class=\"token decorator annotation punctuation\">@hook_impl</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">before_pipeline_run</span><span class=\"token punctuation\">(</span>run_params<span class=\"token punctuation\">,</span> pipeline<span class=\"token punctuation\">,</span> catalog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    missing_input <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>i <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> pipeline<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>catalog<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>_exists<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>missing_input<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">raise</span> DataSetNotFoundError<span class=\"token punctuation\">(</span>textwrap<span class=\"token punctuation\">.</span>dedent<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'''\n\n    </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>Fore<span class=\"token punctuation\">.</span>LIGHTBLACK_EX<span class=\"token punctuation\">}</span></span><span class=\"token string\">‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï  </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>Fore<span class=\"token punctuation\">.</span>RED<span class=\"token punctuation\">}</span></span><span class=\"token string\">PREFLIGHT ERROR </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>Fore<span class=\"token punctuation\">.</span>LIGHTBLACK_EX<span class=\"token punctuation\">}</span></span><span class=\"token string\">‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï\n    </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>Fore<span class=\"token punctuation\">.</span>RESET<span class=\"token punctuation\">}</span></span><span class=\"token string\"> preflight of pipeline failed due to </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>Fore<span class=\"token punctuation\">.</span>YELLOW<span class=\"token punctuation\">}</span></span><span class=\"token string\">missing datasets\n    </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>Fore<span class=\"token punctuation\">.</span>BLUE<span class=\"token punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>missing_input<span class=\"token punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>Fore<span class=\"token punctuation\">.</span>RESET<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n    '''</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Once we are happy with this hook, it can live anywhere.  It can be a module inside our project.  It can be a separate libarary that gets handed out as a back ally wheel, or we can even publish it as its own package to pypi so that anyone can easily pip install it.</p>\n<h3>One Step Back</h3>\n<p><em>a bit of explanation of preflight</em></p>\n<p>If you are not familiar, <code class=\"language-text\">pipeline.inputs()</code> gives us all of the edge inputs into the pipeline.  kedro does also have a <code class=\"language-text\">pipeline.all_inputs()</code> that tells us all of the edge and internal pipeline inputs that will be called throughout the pipeline run.  For this hook we are just concerned with the edge inputs as internal inputs will be generated during the run.</p>\n<p>Also each one of the kedro datasets have an <code class=\"language-text\">_exists()</code> method attached to them to check if the dataset exists or not.  For a more robust implementation of <code class=\"language-text\">preflight</code> it would probably be best to ignore <code class=\"language-text\">AttributeError</code>s, i.e the dataset type does not have an implementation of <code class=\"language-text\">_exists</code>.  It would probably also be a good idea to filter for types such as <code class=\"language-text\">SQLQueryDataSet</code>s that assume <code class=\"language-text\">_exists</code> is False by default.</p>\n<h2>Ideas</h2>\n<p>Now that the juices are flowing what ideas do you have for <code class=\"language-text\">kedro</code> hooks?</p>","fields":{"slug":"/blog/creating-the-kedro-preflight-hook/"},"frontmatter":{"date":"2020-05-10T07:12:00.000Z","devto_url":"","devto_id":"","title":"creating the kedro-preflight hook","description":"Kedro Hooks Intro - kedro hooks are an exciting upcoming feature of kedro `0.16.0`.  They allow you to hook into `catalog_created`,`pipeline_run`, and `node_run`(nouns). With a `before`, or `after` (adjective).  This really reminds me of reacts lifecycle hooks, that let you hook into various state of react web components.  This is going to make kedro so extendable by the community.  I am super pumped to see what the community is able to do with this ability.","path":"kedro-hooks-preflight","twitter_cover":null,"cover":{"absolutePath":"/home/runner/work/waylonwalkerv2/waylonwalkerv2/static/kedro-hooks.png","childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABuElEQVQY02MQV9RX1TV9//JSfGq+T3Csq2+4uYN3R+8UUztPTSN7BXUzJXVzHV17XT17SysPSxsPKxt3K1s3KxsXUwtbBlEFPW1ju9MnD9Q0de7ac2Dx8rUbNm+/dftubXPXhYtX4+LyRKS1dfQc9PTtbW19bO287Ry8re3czSwdTcxtGSSV9OU1TDUM7a2d/QPCk5x9whKzi7JKqzSN7CbNnGfjEiAkq6Wla6etZ2do6mRq5mRq7mhkYqdnaK5vZM4gqWwgoaQvpqArIqvNK6kmJquTbBQbqR9eb1/opeVTapXZ4lSaaJ3Y4FqSa5emoG2kp2eto2+mY2yvq28G0gxBUioG4sr6KmrmO4KmXY1eWetYuMins9Am823iriKH7BTbpLux69zMfDW0tfW1ZK2tDWyszaGagZYDkbiSnqyycZ51Wp9LdZ8rCE10q13q3VXlkLfQt3N78DQLY2ctDXlJCXE9dQlzMxMGuE4IklQykFICiSiomIgp6impmgor6gDDRU3dQlXLXEvPSkPLWERYUEZeTVrFiAFZJ9x+UChASV1JsKCYoi6QlFM1VtY0lVLUEVcEyQIAxDV8cMYTvjsAAAAASUVORK5CYII=","width":1000,"height":420,"src":"/static/4c36fae820f88920f1e380da56b6ed12/a8734/kedro-hooks.png","srcSet":"/static/4c36fae820f88920f1e380da56b6ed12/a8734/kedro-hooks.png 1x"},"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABuElEQVQY02MQV9RX1TV9//JSfGq+T3Csq2+4uYN3R+8UUztPTSN7BXUzJXVzHV17XT17SysPSxsPKxt3K1s3KxsXUwtbBlEFPW1ju9MnD9Q0de7ac2Dx8rUbNm+/dftubXPXhYtX4+LyRKS1dfQc9PTtbW19bO287Ry8re3czSwdTcxtGSSV9OU1TDUM7a2d/QPCk5x9whKzi7JKqzSN7CbNnGfjEiAkq6Wla6etZ2do6mRq5mRq7mhkYqdnaK5vZM4gqWwgoaQvpqArIqvNK6kmJquTbBQbqR9eb1/opeVTapXZ4lSaaJ3Y4FqSa5emoG2kp2eto2+mY2yvq28G0gxBUioG4sr6KmrmO4KmXY1eWetYuMins9Am823iriKH7BTbpLux69zMfDW0tfW1ZK2tDWyszaGagZYDkbiSnqyycZ51Wp9LdZ8rCE10q13q3VXlkLfQt3N78DQLY2ctDXlJCXE9dQlzMxMGuE4IklQykFICiSiomIgp6impmgor6gDDRU3dQlXLXEvPSkPLWERYUEZeTVrFiAFZJ9x+UChASV1JsKCYoi6QlFM1VtY0lVLUEVcEyQIAxDV8cMYTvjsAAAAASUVORK5CYII=","aspectRatio":2.380952380952381,"src":"/static/4c36fae820f88920f1e380da56b6ed12/a8734/kedro-hooks.png","srcSet":"/static/4c36fae820f88920f1e380da56b6ed12/2d6f8/kedro-hooks.png 250w,\n/static/4c36fae820f88920f1e380da56b6ed12/03ac3/kedro-hooks.png 500w,\n/static/4c36fae820f88920f1e380da56b6ed12/a8734/kedro-hooks.png 1000w","sizes":"(max-width: 1000px) 100vw, 1000px"}}}}}},"pageContext":{"id":"4b6b064d-73af-5dfd-997b-41af2f97a814"}}}